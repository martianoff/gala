# Contributing to GALA

Thank you for your interest in contributing to GALA. This guide explains how to set up
your development environment, run tests, and submit changes.

## Prerequisites

You will need the following installed on your system:

| Tool      | Version    | Purpose                          |
|-----------|------------|----------------------------------|
| Go        | 1.22+      | Host language for the transpiler |
| Bazel     | 7.x+       | Build system (via Bazelisk)      |
| Git       | 2.x+       | Version control                  |

We recommend installing Bazel through [Bazelisk](https://github.com/bazelbuild/bazelisk),
which automatically downloads the correct Bazel version.

## Setting Up the Development Environment

1. Fork and clone the repository:

   ```bash
   git clone https://github.com/<your-username>/gala.git
   cd gala
   ```

2. Verify the build works:

   ```bash
   bazel build //...
   ```

3. Run all tests:

   ```bash
   bazel test //...
   ```

4. Build the CLI binary:

   ```bash
   bazel build //cmd/gala:gala
   ```

The binary will be at `bazel-bin/cmd/gala/gala_/gala` (or `gala.exe` on Windows).

## Running Tests

All testing is done through Bazel:

```bash
# Run all tests
bazel test //...

# Run a specific test
bazel test //examples:hello_test

# Run transpiler unit tests
bazel test //internal/transpiler/...
```

GALA has two categories of tests:

- **Unit tests** (Go `testing` package with `testify`): Located under `internal/` and `std/`.
  These test transpiler internals, type inference, and code generation.
- **Output comparison tests** (`gala_test`): Located under `examples/`. Each `.gala` file has
  a corresponding `.out` file with expected output. The test compiles and runs the GALA program,
  then compares stdout against the `.out` file.

## Code Style

### Go Code (transpiler, standard library runtime)

- Add compile-time interface checks: `var _ Interface = (*Implementation)(nil)`
- Prefer generics over reflection
- Use dependency injection via constructors
- Avoid global variables and singletons
- Define custom error types with the `errors` package
- Write table-driven tests

### GALA Code (standard library, examples)

- Prefer functional style, pattern matching, and immutable variables
- Prefer implicit typing: omit generic params, lambda param types, variable types, and
  method type params when they can be inferred
- Use `val` (immutable) by default; use `var` only when mutation is necessary
- Use sealed types instead of iota enums
- Prefer GALA collections (`Array`, `List`) over Go slices

## Project Architecture

```
gala/
  cmd/gala/                        # CLI entry point (Cobra)
  internal/
    parser/grammar/                # ANTLR4 grammar and generated parser
    transpiler/
      generator/                   # Go source code generation from Go AST
      transformer/                 # GALA parse tree -> Go AST transformation
  std/                             # Standard library (Option, Either, Try, etc.)
  collection_immutable/            # Immutable collections (Array, List, HashMap, ...)
  collection_mutable/              # Mutable collection variants
  concurrent/                      # Future, Promise, ExecutionContext
  stream/                          # Lazy sequences
  test/                            # Test framework
  examples/                        # Verification programs (output comparison tests)
  docs/                            # Language specification and documentation
  ide/intellij/                    # IntelliJ IDEA plugin
```

## How to Add a New Language Feature

Adding a feature to GALA follows a pipeline. Complete each step in order:

### Step 1: Grammar (if new syntax is needed)

Edit the ANTLR4 grammar file at `internal/parser/grammar/gala.g4`. The parser is
regenerated automatically by Bazel -- no local ANTLR4 installation is needed:

```bash
# Bazel regenerates the parser from gala.g4 automatically
bazel build //internal/parser/grammar:gala_grammar_go
```

**Important:** Never manually edit the generated `.go` files in `internal/parser/grammar/`.
They are overwritten every time the grammar is regenerated by Bazel.

### Step 2: Analyzer

If your feature introduces new types, declarations, or resolution rules, update the
analyzer in `internal/transpiler/transformer/`. The analyzer extracts metadata from the
parse tree (struct fields, sealed type variants, method signatures, etc.) that the
transformer uses later.

### Step 3: Transformer

Implement the GALA-to-Go AST transformation in `internal/transpiler/transformer/`.
This is where GALA semantics are converted to Go semantics. Key files:

- `transformer.go` -- main visitor, dispatches to specialized handlers
- `match.go` -- pattern matching
- `sealed.go` -- sealed type generation
- `type_inference.go` -- type inference engine
- `lambdas.go` -- lambda expressions and closures
- `calls.go` -- function and method call transformation

### Step 4: Generator (if needed)

If the Go AST output needs new rendering logic, update `internal/transpiler/generator/`.
Most features do not require generator changes since Go AST nodes map directly to Go source.

### Step 5: Tests

Every new feature requires tests at two levels:

1. **Unit tests** -- Add Go test cases in the relevant `*_test.go` file under `internal/`.
   Use table-driven tests with `testify` assertions.

2. **Output comparison tests** -- Add a `.gala` file and corresponding `.out` file in
   `examples/`. This verifies end-to-end correctness.

### Step 6: Documentation

Update the relevant documentation files:

- `docs/GALA.MD` -- Language reference (required for all syntax changes)
- `docs/TYPE_INFERENCE.MD` -- If type inference rules changed
- `docs/EXAMPLES.MD` -- Add a concise example of the feature

### Step 7: Pre-Commit Verification

Before submitting, verify everything passes:

```bash
bazel build //...
bazel test //...
bazel run //:gazelle       # if files were added or removed
```

## Submitting a Pull Request

1. Create a feature branch from `master`:

   ```bash
   git checkout -b feature/my-feature master
   ```

2. Make your changes, following the steps above.

3. Ensure all builds and tests pass:

   ```bash
   bazel build //...
   bazel test //...
   ```

4. Write a clear commit message. Use a prefix indicating the type of change:

   - `feat:` -- new feature
   - `fix:` -- bug fix
   - `doc:` -- documentation only
   - `refactor:` -- code restructuring with no behavior change
   - `test:` -- adding or updating tests

5. Push and open a pull request against `master`.

6. In the PR description, include:
   - What the change does and why
   - Example GALA code demonstrating the feature (if applicable)
   - Which documentation files were updated

## Reporting Bugs

When filing a bug report, include:

- GALA source code that reproduces the issue (minimal example)
- Expected behavior
- Actual behavior (error message or incorrect output)
- GALA version (`gala version`) and OS

## Questions?

Open a GitHub Discussion or Issue if you have questions about contributing.
