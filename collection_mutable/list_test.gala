package main

import (
    "fmt"
    . "martianoff/gala/test"
    . "martianoff/gala/collection_mutable"
    "martianoff/gala/go_interop"
)

// === List Creation Tests ===

func TestEmptyList(t T) T {
    var list = EmptyList[int]()
    var t1 = IsTrue(t, list.IsEmpty())
    return Eq[int](t1, list.Length(), 0)
}

func TestListOf(t T) T {
    var list = ListOf[int](1, 2, 3)
    var t1 = IsFalse(t, list.IsEmpty())
    return Eq[int](t1, list.Length(), 3)
}

func TestListFromSlice(t T) T {
    var slice = go_interop.SliceOf(10, 20, 30)
    var list = ListFromSlice(slice)
    var t1 = Eq[int](t, list.Length(), 3)
    return Eq[int](t1, list.Get(0), 10)
}

// === List Access Tests ===

func TestListGet(t T) T {
    var list = ListOf[int](10, 20, 30)
    var t1 = Eq[int](t, list.Get(0), 10)
    var t2 = Eq[int](t1, list.Get(1), 20)
    return Eq[int](t2, list.Get(2), 30)
}

func TestListHead(t T) T {
    var list = ListOf[string]("first", "second", "third")
    return Eq[string](t, list.Head(), "first")
}

func TestListLast(t T) T {
    var list = ListOf[string]("first", "second", "third")
    return Eq[string](t, list.Last(), "third")
}

func TestListHeadOption(t T) T {
    var list = ListOf[int](42)
    var opt = list.HeadOption()
    var t1 = IsSome(t, opt)
    return Eq[int](t1, opt.Get(), 42)
}

func TestListHeadOptionEmpty(t T) T {
    var list = EmptyList[int]()
    var opt = list.HeadOption()
    return IsNone(t, opt)
}

func TestListLastOption(t T) T {
    var list = ListOf[int](1, 2, 3)
    var opt = list.LastOption()
    var t1 = IsSome(t, opt)
    return Eq[int](t1, opt.Get(), 3)
}

// === List Mutation Tests ===

func TestListSet(t T) T {
    var list = ListOf[int](1, 2, 3)
    list.Set(1, 99)
    return Eq[int](t, list.Get(1), 99)
}

func TestListPrepend(t T) T {
    var list = ListOf[int](2, 3)
    list.Prepend(1)
    var t1 = Eq[int](t, list.Length(), 3)
    return Eq[int](t1, list.Head(), 1)
}

func TestListAppend(t T) T {
    var list = ListOf[int](1, 2)
    list.Append(3)
    var t1 = Eq[int](t, list.Length(), 3)
    return Eq[int](t1, list.Last(), 3)
}

func TestListInsert(t T) T {
    var list = ListOf[int](1, 3)
    list.Insert(1, 2)
    var t1 = Eq[int](t, list.Length(), 3)
    var t2 = Eq[int](t1, list.Get(0), 1)
    var t3 = Eq[int](t2, list.Get(1), 2)
    return Eq[int](t3, list.Get(2), 3)
}

func TestListRemoveAt(t T) T {
    var list = ListOf[int](1, 2, 3)
    var removed = list.RemoveAt(1)
    var t1 = Eq[int](t, removed, 2)
    var t2 = Eq[int](t1, list.Length(), 2)
    var t3 = Eq[int](t2, list.Get(0), 1)
    return Eq[int](t3, list.Get(1), 3)
}

func TestListRemoveFirst(t T) T {
    var list = ListOf[int](1, 2, 3)
    var removed = list.RemoveFirst()
    var t1 = Eq[int](t, removed, 1)
    var t2 = Eq[int](t1, list.Length(), 2)
    return Eq[int](t2, list.Head(), 2)
}

func TestListRemoveLast(t T) T {
    var list = ListOf[int](1, 2, 3)
    var removed = list.RemoveLast()
    var t1 = Eq[int](t, removed, 3)
    var t2 = Eq[int](t1, list.Length(), 2)
    return Eq[int](t2, list.Last(), 2)
}

func TestListClear(t T) T {
    var list = ListOf[int](1, 2, 3)
    list.Clear()
    return IsTrue(t, list.IsEmpty())
}

func TestListReverse(t T) T {
    var list = ListOf[int](1, 2, 3)
    list.Reverse()
    var t1 = Eq[int](t, list.Get(0), 3)
    var t2 = Eq[int](t1, list.Get(1), 2)
    return Eq[int](t2, list.Get(2), 1)
}

// === List Search Tests ===

func TestListContains(t T) T {
    var list = ListOf[int](1, 2, 3)
    var t1 = IsTrue(t, list.Contains(2))
    return IsFalse(t1, list.Contains(5))
}

func TestListIndexOf(t T) T {
    var list = ListOf[string]("a", "b", "c")
    var t1 = Eq[int](t, list.IndexOf("b"), 1)
    return Eq[int](t1, list.IndexOf("z"), -1)
}

func TestListLastIndexOf(t T) T {
    var list = ListOf[int](1, 2, 1, 3)
    return Eq[int](t, list.LastIndexOf(1), 2)
}

// === List Transformation Tests ===

func doubleValueList(x int) int = x * 2

func TestListMap(t T) T {
    var list = ListOf[int](1, 2, 3)
    var mapped = List_Map[int, int](list, doubleValueList)
    var t1 = Eq[int](t, mapped.Get(0), 2)
    var t2 = Eq[int](t1, mapped.Get(1), 4)
    return Eq[int](t2, mapped.Get(2), 6)
}

func isEvenList(x int) bool = x % 2 == 0

func TestListFilter(t T) T {
    var list = ListOf[int](1, 2, 3, 4, 5)
    var filtered = list.Filter(isEvenList)
    var t1 = Eq[int](t, filtered.Length(), 2)
    var t2 = Eq[int](t1, filtered.Get(0), 2)
    return Eq[int](t2, filtered.Get(1), 4)
}

func sumList(acc int, x int) int = acc + x

func TestListFoldLeft(t T) T {
    var list = ListOf[int](1, 2, 3, 4)
    var result = List_FoldLeft[int](list, 0, sumList)
    return Eq[int](t, result, 10)
}

func foldRightHelper(x int, acc string) string {
    if acc == "" {
        return fmt.Sprintf("%d", x)
    }
    return fmt.Sprintf("%d,%s", x, acc)
}

func TestListFoldRight(t T) T {
    var list = ListOf[int](1, 2, 3)
    var result = list.FoldRight[string]("", foldRightHelper)
    return Eq[string](t, result, "1,2,3")
}

// === List Predicate Tests ===

func isGreaterThanZeroList(x int) bool = x > 0

func TestListExists(t T) T {
    var list = ListOf[int](-1, 0, 1, 2)
    return IsTrue(t, list.Exists(isGreaterThanZeroList))
}

func TestListForAll(t T) T {
    var list1 = ListOf[int](1, 2, 3)
    var list2 = ListOf[int](-1, 0, 1)
    var t1 = IsTrue(t, list1.ForAll(isGreaterThanZeroList))
    return IsFalse(t1, list2.ForAll(isGreaterThanZeroList))
}

func isGreaterThanTenList(x int) bool = x > 10

func TestListFind(t T) T {
    var list = ListOf[int](5, 15, 25)
    var found = list.Find(isGreaterThanTenList)
    var t1 = IsSome(t, found)
    return Eq[int](t1, found.Get(), 15)
}

func TestListFindLast(t T) T {
    var list = ListOf[int](5, 15, 25)
    var found = list.FindLast(isGreaterThanTenList)
    var t1 = IsSome(t, found)
    return Eq[int](t1, found.Get(), 25)
}

func TestListCount(t T) T {
    var list = ListOf[int](1, 2, 3, 4, 5)
    var count = list.Count(isEvenList)
    return Eq[int](t, count, 2)
}

// === List Utility Tests ===

func TestListTake(t T) T {
    var list = ListOf[int](1, 2, 3, 4, 5)
    var taken = list.Take(3)
    var t1 = Eq[int](t, taken.Length(), 3)
    return Eq[int](t1, taken.Last(), 3)
}

func TestListDrop(t T) T {
    var list = ListOf[int](1, 2, 3, 4, 5)
    var dropped = list.Drop(2)
    var t1 = Eq[int](t, dropped.Length(), 3)
    return Eq[int](t1, dropped.Head(), 3)
}

func TestListSlice(t T) T {
    var list = ListOf[int](1, 2, 3, 4, 5)
    var sliced = list.Slice(1, 4)
    var t1 = Eq[int](t, sliced.Length(), 3)
    var t2 = Eq[int](t1, sliced.Head(), 2)
    return Eq[int](t2, sliced.Last(), 4)
}

func TestListClone(t T) T {
    var list = ListOf[int](1, 2, 3)
    var clone = list.Clone()
    clone.Set(0, 99)
    var t1 = Eq[int](t, list.Get(0), 1)
    return Eq[int](t1, clone.Get(0), 99)
}

func TestListDistinct(t T) T {
    var list = ListOf[int](1, 2, 2, 3, 3, 3)
    var distinct = list.Distinct()
    return Eq[int](t, distinct.Length(), 3)
}

func TestListZip(t T) T {
    var list1 = ListOf[int](1, 2, 3)
    var list2 = ListOf[string]("a", "b", "c")
    var zipped = list1.Zip[string](list2)
    var t1 = Eq[int](t, zipped.Length(), 3)
    var first = zipped.Get(0)
    var t2 = Eq[int](t1, first.V1.Get(), 1)
    return Eq[string](t2, first.V2.Get(), "a")
}

func TestListString(t T) T {
    var list = ListOf[int](1, 2, 3)
    return Eq[string](t, list.String(), "List(1, 2, 3)")
}

func TestEmptyListString(t T) T {
    var list = EmptyList[int]()
    return Eq[string](t, list.String(), "List()")
}

// === List Mutability Tests ===

func TestListMutability(t T) T {
    var list = ListOf[int](1, 2, 3)
    list.Append(4)
    list.Set(0, 10)
    var t1 = Eq[int](t, list.Length(), 4)
    var t2 = Eq[int](t1, list.Get(0), 10)
    return Eq[int](t2, list.Get(3), 4)
}

func TestListMultipleMutations(t T) T {
    var list = ListOf[int](1, 2, 3)
    list.Append(4)
    list.Prepend(0)
    list.Set(2, 99)
    list.RemoveAt(3)
    var t1 = Eq[int](t, list.Length(), 4)
    var t2 = Eq[int](t1, list.Get(0), 0)
    var t3 = Eq[int](t2, list.Get(2), 99)
    return Eq[int](t3, list.Get(3), 4)
}

// === Large List Tests ===

func TestListLargeAppend(t T) T {
    var list = EmptyList[int]()
    for i := 0; i < 10000; i++ {
        list.Append(i)
    }
    var t1 = Eq[int](t, list.Length(), 10000)
    var t2 = Eq[int](t1, list.Head(), 0)
    return Eq[int](t2, list.Last(), 9999)
}

func TestListLargePrepend(t T) T {
    var list = EmptyList[int]()
    for i := 0; i < 10000; i++ {
        list.Prepend(i)
    }
    var t1 = Eq[int](t, list.Length(), 10000)
    var t2 = Eq[int](t1, list.Head(), 9999)
    return Eq[int](t2, list.Last(), 0)
}

// === O(1) Head/Tail Tests ===

func TestListO1Head(t T) T {
    var list = EmptyList[int]()
    for i := 0; i < 10000; i++ {
        list.Append(i)
    }
    var h = list.Head()
    return Eq[int](t, h, 0)
}

func TestListO1Last(t T) T {
    var list = EmptyList[int]()
    for i := 0; i < 10000; i++ {
        list.Append(i)
    }
    var l = list.Last()
    return Eq[int](t, l, 9999)
}

// === Conversion Tests ===

func TestListToGoSlice(t T) T {
    var list = ListOf[int](1, 2, 3)
    var slice = list.ToGoSlice()
    var t1 = Eq[int](t, len(slice), 3)
    var t2 = Eq[int](t1, slice[0], 1)
    return Eq[int](t2, slice[2], 3)
}

func TestListToArray(t T) T {
    var list = ListOf[int](1, 2, 3)
    var arr = list.ToArray()
    var t1 = Eq[int](t, arr.Length(), 3)
    var t2 = Eq[int](t1, arr.Get(0), 1)
    return Eq[int](t2, arr.Get(2), 3)
}
