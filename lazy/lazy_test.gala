package main

import (
    . "martianoff/gala/test"
    . "martianoff/gala/lazy"
)

func TestNew(t T) T {
    val l = New[int](() => 42)
    return Eq[int](t, l.Get(), 42)
}

func TestOf(t T) T {
    val l = Of[int](99)
    var t1 = IsTrue(t, l.IsEvaluated())
    return Eq[int](t1, l.Get(), 99)
}

func TestGetCaching(t T) T {
    var count = 0
    val l = New[int](() => {
        count = count + 1
        return 10
    })
    val first = l.Get()
    val second = l.Get()
    var t1 = Eq[int](t, first, 10)
    var t2 = Eq[int](t1, second, 10)
    return Eq[int](t2, count, 1)
}

func TestIsEvaluated(t T) T {
    val l = New[int](() => 5)
    var t1 = IsFalse(t, l.IsEvaluated())
    l.Get()
    return IsTrue(t1, l.IsEvaluated())
}

func TestMap(t T) T {
    val l = New[int](() => 10)
    val mapped = l.Map[int]((x int) => x * 2)
    var t1 = IsFalse(t, mapped.IsEvaluated())
    var t2 = Eq[int](t1, mapped.Get(), 20)
    return IsTrue(t2, mapped.IsEvaluated())
}

func TestFlatMap(t T) T {
    val l = New[int](() => 5)
    val chained = l.FlatMap[int]((x int) => New[int](() => x + 3))
    var t1 = IsFalse(t, chained.IsEvaluated())
    return Eq[int](t1, chained.Get(), 8)
}
